

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>8. Downstream analysis &#8212; Handbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/08-process';</script>
    <link rel="shortcut icon" href="../_static/favicon_32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="7. Training models with DeepProfiler" href="07-train.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="00-welcome.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/banner.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/banner.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="00-welcome.html">
                    Welcome to DeepProfiler
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-install.html">1. Install DeepProfiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-structure.html">2. Project structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-images.html">3. Images and segmentation masks</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-metadata.html">4. Metadata and single-cell locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-config.html">5. Configuration file and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-profiling.html">6. Profile cells with DeepProfiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-train.html">7. Training models with DeepProfiler</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">8. Downstream analysis</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cytomining/DeepProfiler-handbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cytomining/DeepProfiler-handbook/edit/main/DeepProfiler-Handbook/docs/08-process.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cytomining/DeepProfiler-handbook/issues/new?title=Issue%20on%20page%20%2Fdocs/08-process.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/08-process.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>8. Downstream analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">8. Downstream analysis</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-and-evaluating-profiles-with-profiling-notebooks">8.1 Aggregating and evaluating profiles with profiling notebooks</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregation-of-profiles-and-batch-correction">8.1.1 Aggregation of profiles and batch-correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-correction-using-sphering-transformation">8.1.2 Batch-correction using sphering transformation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-of-profiles">8.1.3 Evaluation of profiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-profiles">8.1.4 Visualize profiles</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-and-evaluating-profiles-with-pycytominer">8.2 Aggregating and evaluating profiles with Pycytominer</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="downstream-analysis">
<h1>8. Downstream analysis<a class="headerlink" href="#downstream-analysis" title="Permalink to this heading">#</a></h1>
<p>After aggregating, profiles are typically processed before being used for analysis purposes.
Data-processing approaches for profiles extracted with CellProfiler were described in the paper
“<a class="reference external" href="https://doi.org/10.1038/nmeth.4397">Data analysis strategies for image-based profiling</a>”.
Some of those approaches were used for features extracted with DeepProfiler.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="aggregating-and-evaluating-profiles-with-profiling-notebooks">
<h1>8.1 Aggregating and evaluating profiles with profiling notebooks<a class="headerlink" href="#aggregating-and-evaluating-profiles-with-profiling-notebooks" title="Permalink to this heading">#</a></h1>
<p>To analyse benchmark datasets <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2022.08.12.503783v1.full">analysis paper</a> we created
Jupyter notebooks, which are available in <a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments">DeepProfilerExperiments Github repository</a>.
Folders <code class="docutils literal notranslate"><span class="pre">ta-orf</span></code> (BBBC037 dataset), <code class="docutils literal notranslate"><span class="pre">bbbc022</span></code> and <code class="docutils literal notranslate"><span class="pre">cdrp</span></code> (BBBC036 dataset) correspond to benchmark datasets and contain
Jupyter notebooks, <code class="docutils literal notranslate"><span class="pre">profiling</span></code> folder contains utility functions. Next, we are going to go through the most important
analysis notebooks. You can reuse this code to build a custom analysis pipeline.</p>
<section id="aggregation-of-profiles-and-batch-correction">
<h2>8.1.1 Aggregation of profiles and batch-correction<a class="headerlink" href="#aggregation-of-profiles-and-batch-correction" title="Permalink to this heading">#</a></h2>
<p>Aggregation of features can be done with <a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments/blob/master/ta-orf/01-create-profiles.ipynb"><code class="docutils literal notranslate"><span class="pre">01-create-profiles.ipynb</span></code></a>
Jupyter notebook. The inputs are: <a class="reference external" href="https://cytomining.github.io/DeepProfiler-handbook/docs/04-metadata.html#the-metadata-file">project metadata file</a>, ground truth metadata
with annotations of treatments by the mechanism of action and the <code class="docutils literal notranslate"><span class="pre">.npz</span></code> files with features  organized in
<code class="docutils literal notranslate"><span class="pre">{Plate}/{Well}/{Site}.npz</span></code> folder structure.</p>
<ol class="arabic simple">
<li><p>Define the parameters: project path and experiment folder name as in DeepProfiler, sphering regularization parameter <code class="docutils literal notranslate"><span class="pre">REG_PARAM</span></code> and
output file names: <code class="docutils literal notranslate"><span class="pre">OUTPUT_FILE</span></code> - output file that will contain well-level profiles after sphering and <code class="docutils literal notranslate"><span class="pre">MATRIX_FILE</span></code> that will contain similarity matrix of treatments.</p></li>
<li><p>Load single-cell data by passing through metadata and reading files with features. It might require a significant amount of RAM (depending on the size of the dataset).</p></li>
<li><p>Aggregate features of single-cells by site with median aggregation. <code class="docutils literal notranslate"><span class="pre">sites</span></code> Pandas dataframe will contain those aggregated profiles.</p></li>
<li><p>Aggregate site-level profiles to well-level using mean aggregation and store them in <code class="docutils literal notranslate"><span class="pre">wells</span></code> dataframe.</p></li>
<li><p>Sphering: calculate the sphering transformation <strong>using control wells only</strong> and then apply this transformation to all well-level profiles in <code class="docutils literal notranslate"><span class="pre">wells</span></code>.</p></li>
<li><p>Aggregate well-level profiles to treatment-level profiles. Only treatments with ground truth annotations are aggregated and stored in <code class="docutils literal notranslate"><span class="pre">profiles</span></code> dataframe.</p></li>
<li><p>Create a similarity matrix from <code class="docutils literal notranslate"><span class="pre">profiles</span></code>. We use cosine similarity as a similarity metric. Save the matrix to <code class="docutils literal notranslate"><span class="pre">OUTPUT_FILE</span></code>.</p></li>
</ol>
</section>
<section id="batch-correction-using-sphering-transformation">
<h2>8.1.2 Batch-correction using sphering transformation<a class="headerlink" href="#batch-correction-using-sphering-transformation" title="Permalink to this heading">#</a></h2>
<p>The sphering transformation (<a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments/blob/master/profiling/profiling.py#L5">implementation</a>)
aims to reduce unwanted technical variation and recover the phenotypic features of treatments from
the latent representations of the weakly supervised CNN. We calculate the ZCA-transformation matrix using well-level profiles
of negative controls. The assumption here is that phenotypic features of negative controls should be neutral, thus the
difference between them encodes mostly technical and irrelevant variation.</p>
<p>Sphering transformation can be regularized, the strength of regularization is regulated by <code class="docutils literal notranslate"><span class="pre">REG_PARAM</span></code> in the notebook,
a good value to start is <code class="docutils literal notranslate"><span class="pre">1e-3</span></code>, though it depends on the data.</p>
<p>The calсulated ZCA-transformation matrix is used to calculate corrected profiles (both for treated wells and control
wells). On the UMAP plot, negative control wells are expected to group, and treated wells
with relatively weak phenotypes are also expected to group with negative control wells.</p>
<figure class="align-default" id="sphering">
<img alt="../_images/sphering.png" src="../_images/sphering.png" />
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">UMAP of well-level profiles before and after sphering (BBBC037 dataset). Red point are control wells, gray points are
treated wells and blue points are treatments.</span><a class="headerlink" href="#sphering" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="evaluation-of-profiles">
<h2>8.1.3 Evaluation of profiles<a class="headerlink" href="#evaluation-of-profiles" title="Permalink to this heading">#</a></h2>
<p>Evaluation of profiles can be done with <a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments/blob/master/ta-orf/04-downstream-analysis.ipynb"><code class="docutils literal notranslate"><span class="pre">04-downstream-analysis.ipynb</span></code></a>. This notebook uses the cosine similarity matrix
obtained in <a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments/blob/master/ta-orf/01-create-profiles.ipynb"><code class="docutils literal notranslate"><span class="pre">01-create-profiles.ipynb</span></code></a> as an input.</p>
<ol class="arabic simple">
<li><p>First parts (<em>Load similarity matrix</em> and <em>MOA matching</em>) of the notebook perform input pre-processing. <code class="docutils literal notranslate"><span class="pre">moa_matches</span></code>
is a binary matrix of size <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">x</span> <span class="pre">n</span></code>, where <code class="docutils literal notranslate"><span class="pre">n</span></code> is the number of treatments in the similarity matrix. This matrix is symmetrical
and each row (column) relates is a treatment, and values are <code class="docutils literal notranslate"><span class="pre">True</span></code> in each row (column) for the current treatment (diagonal)
and treatments that belong to the same mechanism of action as the current treatment.</p></li>
<li><p>Calculate the precision metrics: <code class="docutils literal notranslate"><span class="pre">Average</span> <span class="pre">precision</span></code> and <code class="docutils literal notranslate"><span class="pre">Precision</span> <span class="pre">&#64;</span> <span class="pre">top</span> <span class="pre">1%</span></code>.</p></li>
<li><p>Calculate the recall metrics: <code class="docutils literal notranslate"><span class="pre">Recall</span></code> and <code class="docutils literal notranslate"><span class="pre">Average</span> <span class="pre">Recall</span> <span class="pre">at</span> <span class="pre">top</span> <span class="pre">10%</span></code> (a different cut-off was used on purpose).</p></li>
<li><p>Calculate mean Average Precision, and area under interpolated Precision-Recall curve and plot it.</p></li>
<li><p>Save results to the <code class="docutils literal notranslate"><span class="pre">.csv</span></code> table and <code class="docutils literal notranslate"><span class="pre">pickle</span></code> (contains Python dictionary and can be loaded with Python).</p></li>
</ol>
</section>
<section id="visualize-profiles">
<h2>8.1.4 Visualize profiles<a class="headerlink" href="#visualize-profiles" title="Permalink to this heading">#</a></h2>
<p>The visualizations can be done with <a class="reference external" href="https://github.com/broadinstitute/DeepProfilerExperiments/blob/master/ta-orf/02-profiles-visualizations.ipynb"><code class="docutils literal notranslate"><span class="pre">02-profiles-visualizations.ipynb</span></code></a>
Jupyter notebook. The input is a path to well-level profiles and is set in <code class="docutils literal notranslate"><span class="pre">INPUT_PROFILES</span></code>.</p>
<ol class="arabic simple">
<li><p>Treatment-level profiles are calculated using mean aggregation.</p></li>
<li><p>The UMAP transformation is obtained using only well-level profiles. Get embeddings for well-level profiles.</p></li>
<li><p>Use transformation from the previous step for treatment level profiles.</p></li>
<li><p>Plot embeddings both from well and treatment-level profiles (see below).</p></li>
</ol>
<figure class="align-default" id="umap-visualization">
<img alt="../_images/visualize_profiles.png" src="../_images/visualize_profiles.png" />
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">Example of visualization (BBBC037 dataset).</span><a class="headerlink" href="#umap-visualization" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="aggregating-and-evaluating-profiles-with-pycytominer">
<h1>8.2 Aggregating and evaluating profiles with Pycytominer<a class="headerlink" href="#aggregating-and-evaluating-profiles-with-pycytominer" title="Permalink to this heading">#</a></h1>
<p>DeepProfiler single-cell profiles can be aggregated via a <a class="reference external" href="https://github.com/cytomining/pycytominer">Pycytominer</a>
function called <a class="reference external" href="https://github.com/cytomining/pycytominer/blob/master/pycytominer/cyto_utils/DeepProfiler_processing.py">DeepProfiler_Processing</a>.
This function reads the output features of DeepProfiler, including the metadata, aggregates, and saves the data in a Pycytominer
and Cytominer-eval readable data frame format.</p>
<p>Make sure to install this version of Pycytominer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cytomining</span><span class="o">/</span><span class="n">pycytominer</span><span class="nd">@update_agg_TF2</span>
</pre></div>
</div>
<p>This code gives an example of how to run the aggregation function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">pycytominer.cyto_utils.DeepProfiler_processing</span> <span class="kn">import</span> <span class="n">AggregateDeepProfiler</span>

<span class="n">project_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="s1">&#39;folder_name&#39;</span>

<span class="n">profile_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">metadata_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;index.csv&quot;</span><span class="p">)</span>

<span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">,</span><span class="n">experiment</span><span class="p">,</span><span class="s1">&#39;aggregated&#39;</span><span class="p">)</span>

<span class="n">well_class</span> <span class="o">=</span> <span class="n">AggregateDeepProfiler</span><span class="p">(</span>
    <span class="n">metadata_file</span><span class="o">=</span><span class="n">metadata_file</span><span class="p">,</span>
    <span class="n">profile_dir</span><span class="o">=</span><span class="n">profile_dir</span><span class="p">,</span>
    <span class="n">aggregate_operation</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
    <span class="n">aggregate_on</span><span class="o">=</span><span class="s2">&quot;well&quot;</span><span class="p">,</span>
    <span class="n">output_file</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">df_well</span> <span class="o">=</span> <span class="n">well_class</span><span class="o">.</span><span class="n">aggregate_deep</span><span class="p">()</span>

<span class="n">df_well</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;aggregated_efficientnet_median.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://github.com/cytomining/cytominer-eval">Cytominer-eval</a> repository contains six functions that calculate different
quality metrics for perturbation profiling experiments: Precision&#64;K and Recall&#64;K, Enrichment, Hit&#64;k, Replicate reproducibility,
MP-value, and Grit.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="07-train.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">7. Training models with DeepProfiler</p>
      </div>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">8. Downstream analysis</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-and-evaluating-profiles-with-profiling-notebooks">8.1 Aggregating and evaluating profiles with profiling notebooks</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregation-of-profiles-and-batch-correction">8.1.1 Aggregation of profiles and batch-correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-correction-using-sphering-transformation">8.1.2 Batch-correction using sphering transformation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-of-profiles">8.1.3 Evaluation of profiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-profiles">8.1.4 Visualize profiles</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-and-evaluating-profiles-with-pycytominer">8.2 Aggregating and evaluating profiles with Pycytominer</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael Bornholdt, Juan Caicedo, Yu Han, Nikita Moshkov, Rebecca Senft (in alphabetical order)
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>